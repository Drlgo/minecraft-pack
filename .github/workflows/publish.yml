name: Auto-Publish Texture Pack

on:
  # Runs automatically every day at 12:00 UTC
  schedule:
    - cron: '0 12 * * *'
  # Allows you to click "Run workflow" manually from the GitHub Actions tab
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Allows the bot to commit the updated pack.mcmeta and version text file

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Mojang for Updates
        id: check_version
        run: |
          # 1. Ask Mojang for the absolute newest release version
          LATEST_MC=$(curl -s https://piston-meta.mojang.com/mc/game/version_manifest_v2.json | jq -r '.latest.release')
          echo "MC_VERSION=$LATEST_MC" >> $GITHUB_ENV
          
          # 2. Safely read our tracking file (or assume 'none' if it is the first time running)
          if [ -f current_mc_version.txt ]; then
            CURRENT_MC=$(cat current_mc_version.txt)
          else
            CURRENT_MC="none"
          fi
          
          # 3. Compare them!
          if [ "$LATEST_MC" == "$CURRENT_MC" ]; then
            echo "Minecraft is still on $LATEST_MC. No update needed. Going back to sleep."
            echo "NEW_UPDATE=false" >> $GITHUB_ENV
          else
            echo "ðŸš¨ New Minecraft version detected! Updating from $CURRENT_MC to $LATEST_MC."
            echo "NEW_UPDATE=true" >> $GITHUB_ENV
            echo $LATEST_MC > current_mc_version.txt
          fi

      - name: Update pack.mcmeta and Commit
        if: env.NEW_UPDATE == 'true'
        run: |
          # 1. Ask the community API for the exact resource pack format of the new version
          FORMAT=$(curl -s https://raw.githubusercontent.com/misode/mcmeta/summary/versions/data.json | jq -r ".[] | select(.id == \"${{ env.MC_VERSION }}\") | .resource_pack_version")
          
          # Fallback: If the API is down, default to 75 so the action doesn't crash
          if [ -z "$FORMAT" ] || [ "$FORMAT" == "null" ]; then
            FORMAT=75
            echo "âš ï¸ Could not fetch dynamic format, falling back to $FORMAT"
          else
            echo "âœ… Successfully fetched dynamic pack_format: $FORMAT"
          fi
          
          # 2. Inject the fetched format into your pack.mcmeta
          cd Drigo*/
          jq --arg format "$FORMAT" '.pack.pack_format = ($format | tonumber)' pack.mcmeta > temp.json && mv temp.json pack.mcmeta
          cd ..
          
          # 3. Save the changes to GitHub
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add current_mc_version.txt Drigo*/pack.mcmeta
          git commit -m "Auto-update pack_format to $FORMAT for MC ${{ env.MC_VERSION }}"
          git push

      - name: Zip the Texture Pack
        if: env.NEW_UPDATE == 'true'
        run: |
          # Enter the folder and zip the contents directly into the workspace root
          cd Drigo*/
          zip -r "../Drigo 3D Lantern's x Punchy.zip" ./*

      - name: Publish to Modrinth and CurseForge
        if: env.NEW_UPDATE == 'true'
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          # IMPORTANT: Make sure these IDs match your actual project IDs!
          modrinth-id: "X4S78Ho4"
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          
          curseforge-id: "1458402"
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          
          name: "Drigo 3D Lantern's x Punchy - MC ${{ env.MC_VERSION }}"
          version: ${{ env.MC_VERSION }}
          files: "Drigo 3D Lantern's x Punchy.zip"
          
          # Tell CurseForge this is a vanilla resource pack
          loaders: "minecraft"
