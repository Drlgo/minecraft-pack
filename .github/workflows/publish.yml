name: Auto-Publish Texture Pack

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Mojang for Updates
        id: check_version
        run: |
          LATEST_MC=$(curl -s https://piston-meta.mojang.com/mc/game/version_manifest_v2.json | jq -r '.latest.release')
          echo "MC_VERSION=$LATEST_MC" >> $GITHUB_ENV
          
          if [ -f current_mc_version.txt ]; then
            CURRENT_MC=$(cat current_mc_version.txt)
          else
            CURRENT_MC="none"
          fi
          
          if [ "$LATEST_MC" == "$CURRENT_MC" ]; then
            echo "Minecraft is still on $LATEST_MC. No update needed."
            echo "NEW_UPDATE=false" >> $GITHUB_ENV
          else
            echo "NEW_UPDATE=true" >> $GITHUB_ENV
            echo $LATEST_MC > current_mc_version.txt
          fi

      - name: Update pack_format and Commit
        if: env.NEW_UPDATE == 'true'
        run: |
          # 1. Get the dynamic format
          FORMAT=$(curl -s https://raw.githubusercontent.com/misode/mcmeta/summary/versions/data.json | jq -r ".[] | select(.id == \"${{ env.MC_VERSION }}\") | .resource_pack_version")
          [ -z "$FORMAT" ] || [ "$FORMAT" == "null" ] && FORMAT=75

          # 2. ONLY update the pack_format number using jq
          cd Drigo*/
          jq --arg format "$FORMAT" '.pack.pack_format = ($format | tonumber)' pack.mcmeta > temp.json && mv temp.json pack.mcmeta
          cd ..
          
          # 3. Save changes
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add current_mc_version.txt Drigo*/pack.mcmeta
          git commit -m "Auto-update pack_format to $FORMAT for MC ${{ env.MC_VERSION }}"
          git push

      - name: Zip the Texture Pack
        if: env.NEW_UPDATE == 'true'
        run: |
          cd Drigo*/
          # Zipping "." ensures no hidden folder levels for Modrinth
          zip -r "../Drigo_3D_Lanterns_x_Punchy.zip" .
          
      - name: Publish to Modrinth and CurseForge
        if: env.NEW_UPDATE == 'true'
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: "X4S78Ho4"
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: "1458402"
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          name: "Drigo 3D Lantern's x Punchy - MC ${{ env.MC_VERSION }}"
          version: ${{ env.MC_VERSION }}
          files: "Drigo_3D_Lanterns_x_Punchy.zip"
          loaders: "minecraft"
